<!doctype html>
<html lang="en">
<head>
	<title>Zwifit Control</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
	      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<link rel="stylesheet" href="/control.css"/>
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
	        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
	        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
	        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
	<script type="text/javascript">
		let activeTarget = 'Incline',
			typeState = '',
			currents = {
				Incline: 0,
				Speed: 0,
				Cadence: 0
			},
			units = {
				Incline: '%',
				Speed: 'mph',
				Cadence: 'spm'
			};
		$(document).ready(() => {
			$('.targets .btn').click(evt => {
				$('.targets .btn').removeClass('active');
				$(evt.target).addClass('active');
				activeTarget = $(evt.target).text();
				syncCurrent();
				typeState = '';
			});
			$('.btn-type').click(evt => {
				typeState += $(evt.target).text();
			});
			$('.btn-go').click(() => {
				try {
					currents[activeTarget] = parseFloat(typeState === '' ? currents[activeTarget] : typeState);
					syncCurrent();
					sendCurrentToServer();
					typeState = '';
				}
				catch (err) {
					alert(err);
				}
			});
			$('.btn-reset').click(() => {
				if (typeState) {
					typeState = '';
				}
				else {
					currents[activeTarget] = 0;
					syncCurrent();
					sendCurrentToServer();
				}
			});
			$('.btn-add').click(() => {
				currents[activeTarget] = Math.round((currents[activeTarget] + 0.1) * 10) / 10;
				syncCurrent();
				sendCurrentToServer();
			});
			$('.btn-minus').click(() => {
				currents[activeTarget] = Math.round((currents[activeTarget] - 0.1) * 10) / 10;
				syncCurrent();
				sendCurrentToServer();
			});
			syncCurrent();
		});

		function syncCurrent() {
			$('.current-value').html(currents[activeTarget]);
			$('.current-unit').html(units[activeTarget]);
		}

		function sendCurrentToServer() {
			fetch('/set', {
				method: 'POST',
				body: activeTarget + '=' + currents[activeTarget]
			})
				.catch(err => alert(err));
		}
	</script>
</head>
<body>
<ul class="current">
	<li class="read-only">Zwifit</li>
</ul>
<ul class="targets">
	<li>
		<button class="btn active" type="button">Incline</button>
	</li>
	<li>
		<button class="btn" type="button">Speed</button>
	</li>
	<li>
		<button class="btn" type="button">Cadence</button>
	</li>
</ul>
<ul class="values">
	<li>
		<button class="btn btn-type" type="button">7</button>
		<button class="btn btn-type" type="button">8</button>
		<button class="btn btn-type" type="button">9</button>

		<button class="btn btn-type" type="button">4</button>
		<button class="btn btn-type" type="button">5</button>
		<button class="btn btn-type" type="button">6</button>

		<button class="btn btn-type" type="button">1</button>
		<button class="btn btn-type" type="button">2</button>
		<button class="btn btn-type" type="button">3</button>

		<button class="btn btn-type" type="button">.</button>
		<button class="btn btn-type" type="button">0</button>
		<button class="btn btn-go" type="button">GO</button>
	</li>
</ul>
<ul class="current">
	<li class="read-only">
		<span class="current-value">0</span>
		<span class="current-unit text-muted">%</span></li>
</ul>
<ul class="increments">
	<li>
		<button class="btn btn-add" type="button">+</button>
	</li>
	<li>
		<button class="btn btn-reset" type="button">0</button>
	</li>
	<li>
		<button class="btn btn-minus" type="button">-</button>
	</li>
</ul>
</body>
</html>